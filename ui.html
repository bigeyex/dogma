<!DOCTYPE html>
<html>

<head>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: #121225;
      padding: 0 8px;
      border-bottom: 1px solid #333;
    }

    .tab {
      padding: 12px 16px;
      font-size: 13px;
      color: #888;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #ccc;
    }

    .tab.active {
      color: #fff;
      border-bottom-color: #3b82f6;
    }

    .tab-content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #fff;
    }

    .description {
      font-size: 12px;
      color: #888;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      color: #888;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      background: #0f0f1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 12px;
      padding: 10px;
      outline: none;
      transition: border-color 0.2s;
    }

    textarea {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      resize: vertical;
      min-height: 120px;
    }

    textarea#html-input {
      height: 200px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #3b82f6;
    }

    .controls {
      display: flex;
      margin-bottom: 12px;
      gap: 16px;
      align-items: center;
    }

    .toggle-group {
      display: flex;
      background: #0f0f1a;
      padding: 2px;
      border-radius: 6px;
      border: 1px solid #333;
    }

    .toggle-group label {
      cursor: pointer;
      padding: 6px 12px;
      font-size: 12px;
      color: #888;
      border-radius: 4px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toggle-group input[type="radio"] {
      display: none;
    }

    .toggle-group input[type="radio"]:checked+label {
      background: #333;
      color: #fff;
      font-weight: 500;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 12px;
      color: #888;
    }

    .checkbox-group input {
      cursor: pointer;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    button {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: #333;
      color: #ccc;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #444;
    }

    .status {
      margin-top: 12px;
      font-size: 11px;
      color: #888;
      text-align: center;
      min-height: 1.2em;
    }

    .thinking-container {
      display: none;
      margin-top: 12px;
      font-size: 11px;
      color: #888;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 1.2em;
    }

    .thinking-container.active {
      display: flex;
    }

    #thinking-status {
      color: #888;
    }

    #token-counter {
      color: #888;
      font-feature-settings: "tnum";
      font-variant-numeric: tabular-nums;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
      display: none;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    button.loading .spinner {
      display: block;
    }
  </style>
</head>

<body>
  <div class="tabs">
    <div class="tab active" data-tab="builder">Builder</div>
    <div class="tab" data-tab="tailwind">Tailwind</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <!-- Builder Tab -->
  <div id="builder-tab" class="tab-content active">
    <h2>AI Builder</h2>
    <p class="description">AI will generate Tailwind HTML based on your prompt.</p>

    <div class="form-group">
      <textarea id="prompt-input"
        placeholder="e.g. A premium landing page hero section with a dark theme, a vibrant call-to-action button, and a feature list."></textarea>
    </div>

    <div class="controls">
      <div class="toggle-group">
        <input type="radio" id="builder-mobile" name="builder-viewport" value="mobile" checked>
        <label for="builder-mobile">ğŸ“± Mobile</label>

        <input type="radio" id="builder-desktop" name="builder-viewport" value="desktop">
        <label for="builder-desktop">ğŸ–¥ï¸ Desktop</label>
      </div>

      <label class="checkbox-group">
        <input type="checkbox" id="thinking-checkbox" checked>
        <span data-i18n="thinkingLabel">Thinking(æ·±åº¦æ€è€ƒ)</span>
      </label>

      <div id="copy-btn" title="Copy generated code"
        style="display: none; margin-left: auto; cursor: pointer; color: #888; align-items: center; transition: color 0.2s;">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </div>
    </div>

    <div class="btn-group">
      <button id="build-btn" class="btn-primary">
        <span class="spinner"></span>
        Build in Figma
      </button>
      <button id="expand-btn" class="btn-secondary">
        <span class="spinner"></span>
        Expand
      </button>
    </div>
    <div id="builder-status" class="status"></div>

    <div id="thinking-container" class="thinking-container">
      <div id="thinking-status">AI is thinking...</div>
      <div id="token-counter">0 tokens</div>
      <a id="stop-btn" class="stop-link"
        style="color: #ef4444; cursor: pointer; font-size: 11px; margin-left: 12px; text-decoration: none;">Stop</a>
    </div>
  </div>

  <!-- Tailwind Tab -->
  <div id="tailwind-tab" class="tab-content">
    <h2>Tailwind â†’ Figma</h2>
    <p class="description">Convert existing Tailwind HTML to Figma layers.</p>

    <div class="controls">
      <div class="toggle-group">
        <input type="radio" id="mobile" name="viewport" value="mobile" checked>
        <label for="mobile">ğŸ“± Mobile</label>

        <input type="radio" id="desktop" name="viewport" value="desktop">
        <label for="desktop">ğŸ–¥ï¸ Desktop</label>
      </div>
    </div>

    <textarea id="html-input"
      placeholder="<div class=&quot;flex flex-col gap-4 p-6 bg-gray-900&quot;>...</div>"></textarea>

    <div class="btn-group">
      <button id="convert" class="btn-primary">Convert</button>
      <button id="cancel-tailwind" class="btn-secondary">Cancel</button>
    </div>
    <div id="tailwind-status" class="status"></div>
  </div>

  <!-- Settings Tab -->
  <div id="settings-tab" class="tab-content">
    <h2>Settings</h2>
    <p class="description">Configure your VolcEngine Ark credentials.</p>

    <div class="form-group">
      <label data-i18n="language">Language</label>
      <select id="language">
        <option value="zh-CN">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="en-US">ğŸ‡ºğŸ‡¸ English</option>
      </select>
    </div>

    <div class="form-group">
      <label data-i18n="provider">Provider</label>
      <select id="provider">
        <option value="volcengine">VolcEngine (Ark)</option>
      </select>
    </div>

    <div class="form-group">
      <label data-i18n="chatModelId">Chat Model ID (for Expand)</label>
      <input type="text" id="chat-model-id" placeholder="doubao-seed-1-8-251228" value="doubao-seed-1-8-251228">
    </div>

    <div class="form-group">
      <label data-i18n="codingModelId">Coding Model ID (for Builder)</label>
      <input type="text" id="coding-model-id" placeholder="doubao-seed-code-preview-251028"
        value="doubao-seed-code-preview-251028">
    </div>

    <div class="form-group">
      <label data-i18n="apiKey">API Key</label>
      <input type="password" id="api-key" placeholder="Enter your API key">
    </div>

    <div class="btn-group">
      <button id="save-settings" class="btn-primary" data-i18n="saveSettings">Save Settings</button>
    </div>
    <div id="settings-status" class="status"></div>
  </div>

  <script>
    // Tab Switching
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.onclick = () => {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
      };
    });

    // Settings logic
    let settings = {
      provider: 'volcengine',
      chatModelId: 'doubao-seed-1-8-251228',
      codingModelId: 'doubao-seed-code-preview-251028',
      apiKey: '',
      language: 'zh-CN'
    };

    const translations = {
      'zh-CN': {
        builderTab: 'æ„å»ºå™¨',
        tailwindTab: 'Tailwind',
        settingsTab: 'è®¾ç½®',
        aiBuilderTitle: 'AI æ„å»ºå™¨',
        aiBuilderDesc: 'AI å°†æ ¹æ®æ‚¨çš„æè¿°ç”Ÿæˆ Tailwind HTMLã€‚',
        promptPlaceholder: 'ä¾‹å¦‚ï¼šä¸€ä¸ªå¸¦æœ‰æ·±è‰²ä¸»é¢˜ã€é†’ç›®çš„å·å¬æ€§ç”¨è¯­æŒ‰é’®å’ŒåŠŸèƒ½åˆ—è¡¨çš„é«˜çº§ç€é™†é¡µè‹±é›„éƒ¨åˆ†ã€‚',
        mobile: 'ğŸ“± æ‰‹æœº',
        desktop: 'ğŸ–¥ï¸ æ¡Œé¢',
        buildBtn: 'åœ¨ Figma ä¸­æ„å»º',
        expandBtn: 'å±•å¼€æè¿°',
        stopBtn: 'åœæ­¢',
        tailwindTitle: 'Tailwind â†’ Figma',
        tailwindDesc: 'å°†ç°æœ‰çš„ Tailwind HTML è½¬æ¢ä¸º Figma å›¾å±‚ã€‚',
        htmlPlaceholder: '<div class="flex flex-col gap-4 p-6 bg-gray-900">...</div>',
        convertBtn: 'è½¬æ¢',
        cancelBtn: 'å–æ¶ˆ',
        settingsTitle: 'è®¾ç½®',
        settingsDesc: 'é…ç½®æ‚¨çš„ç«å±±å¼•æ“ Ark å‡­æ®ã€‚',
        language: 'è¯­è¨€',
        provider: 'æä¾›å•†',
        chatModelId: 'èŠå¤©æ¨¡å‹ ID (ç”¨äºå±•å¼€)',
        codingModelId: 'ç¼–ç æ¨¡å‹ ID (ç”¨äºæ„å»º)',
        apiKey: 'API å¯†é’¥',
        saveSettings: 'ä¿å­˜è®¾ç½®',
        settingsSaved: 'âœ“ è®¾ç½®å·²ä¿å­˜',
        processingIcons: 'æ­£åœ¨å¤„ç†å›¾æ ‡...',
        sentToFigma: 'âœ“ å·²å‘é€åˆ° Figma',
        enterDescription: 'è¯·è¾“å…¥æè¿°ã€‚',
        setApiKey: 'è¯·åœ¨è®¾ç½®æ ‡ç­¾é¡µä¸­è®¾ç½® API å¯†é’¥ã€‚',
        expandingPrompt: 'æ­£åœ¨å±•å¼€æè¿°...',
        expanded: 'âœ“ å·²å±•å¼€ï¼',
        stoppedByUser: 'ç”¨æˆ·å·²åœæ­¢ã€‚',
        contactingAI: 'æ­£åœ¨è”ç³» AI...',
        buildingLayers: 'æ­£åœ¨æ„å»º Figma å›¾å±‚...',
        buildComplete: 'âœ“ æ„å»ºå®Œæˆï¼',
        generationStopped: 'ç”Ÿæˆå·²ç”±ç”¨æˆ·åœæ­¢ã€‚',
        errorPrefix: 'é”™è¯¯: ',
        tokens: 'ä»¤ç‰Œ',
        aiThinking: 'AI æ­£åœ¨æ€è€ƒ...',
        generating: 'æ­£åœ¨ç”Ÿæˆ...',
        thinkingLabel: 'æ·±åº¦æ€è€ƒ'
      },
      'en-US': {
        builderTab: 'Builder',
        tailwindTab: 'Tailwind',
        settingsTab: 'Settings',
        aiBuilderTitle: 'AI Builder',
        aiBuilderDesc: 'AI will generate Tailwind HTML based on your prompt.',
        promptPlaceholder: 'e.g. A premium landing page hero section with a dark theme, a vibrant call-to-action button, and a feature list.',
        mobile: 'ğŸ“± Mobile',
        desktop: 'ğŸ–¥ï¸ Desktop',
        buildBtn: 'Build in Figma',
        expandBtn: 'Expand',
        stopBtn: 'Stop',
        tailwindTitle: 'Tailwind â†’ Figma',
        tailwindDesc: 'Convert existing Tailwind HTML to Figma layers.',
        htmlPlaceholder: '<div class="flex flex-col gap-4 p-6 bg-gray-900">...</div>',
        convertBtn: 'Convert',
        cancelBtn: 'Cancel',
        settingsTitle: 'Settings',
        settingsDesc: 'Configure your VolcEngine Ark credentials.',
        language: 'Language',
        provider: 'Provider',
        chatModelId: 'Chat Model ID (for Expand)',
        codingModelId: 'Coding Model ID (for Builder)',
        apiKey: 'API Key',
        saveSettings: 'Save Settings',
        settingsSaved: 'âœ“ Settings saved',
        processingIcons: 'Processing icons...',
        sentToFigma: 'âœ“ Sent to Figma',
        enterDescription: 'Please enter a description.',
        setApiKey: 'Please set API Key in Settings tab.',
        expandingPrompt: 'Expanding prompt...',
        expanded: 'âœ“ Expanded!',
        stoppedByUser: 'Stopped by user.',
        contactingAI: 'Contacting AI...',
        buildingLayers: 'Building Figma layers...',
        buildComplete: 'âœ“ Build complete!',
        generationStopped: 'Generation stopped by user.',
        errorPrefix: 'Error: ',
        tokens: 'tokens',
        aiThinking: 'AI is thinking...',
        generating: 'Generating...',
        thinkingLabel: 'Thinking'
      }
    };

    function updateUI() {
      const lang = settings.language || 'zh-CN';
      const t = translations[lang];

      // Tabs
      document.querySelector('[data-tab="builder"]').textContent = t.builderTab;
      document.querySelector('[data-tab="tailwind"]').textContent = t.tailwindTab;
      document.querySelector('[data-tab="settings"]').textContent = t.settingsTab;

      // Builder Tab
      document.querySelector('#builder-tab h2').textContent = t.aiBuilderTitle;
      document.querySelector('#builder-tab .description').textContent = t.aiBuilderDesc;
      document.getElementById('prompt-input').placeholder = t.promptPlaceholder;
      document.querySelector('label[for="builder-mobile"]').textContent = t.mobile;
      document.querySelector('label[for="builder-desktop"]').textContent = t.desktop;
      document.querySelector('#build-btn').childNodes[2].textContent = t.buildBtn; // Respect spinner
      document.querySelector('#expand-btn').childNodes[2].textContent = t.expandBtn;
      document.getElementById('stop-btn').textContent = t.stopBtn;
      document.getElementById('thinking-status').textContent = t.aiThinking;
      document.getElementById('token-counter').textContent = `0 ${t.tokens}`;
      const thinkingLabelSpan = document.querySelector('label.checkbox-group span');
      if (thinkingLabelSpan) thinkingLabelSpan.textContent = t.thinkingLabel;

      // Tailwind Tab
      document.querySelector('#tailwind-tab h2').textContent = t.tailwindTitle;
      document.querySelector('#tailwind-tab .description').textContent = t.tailwindDesc;
      document.querySelector('label[for="mobile"]').textContent = t.mobile;
      document.querySelector('label[for="desktop"]').textContent = t.desktop;
      document.getElementById('html-input').placeholder = t.htmlPlaceholder;
      document.getElementById('convert').textContent = t.convertBtn;
      document.getElementById('cancel-tailwind').textContent = t.cancelBtn;

      // Settings Tab
      document.querySelector('#settings-tab h2').textContent = t.settingsTitle;
      document.querySelector('#settings-tab .description').textContent = t.settingsDesc;
      document.querySelector('label[data-i18n="language"]').textContent = t.language;
      document.querySelector('label[data-i18n="provider"]').textContent = t.provider;
      document.querySelector('label[data-i18n="chatModelId"]').textContent = t.chatModelId;
      document.querySelector('label[data-i18n="codingModelId"]').textContent = t.codingModelId;
      document.querySelector('label[data-i18n="apiKey"]').textContent = t.apiKey;
      document.getElementById('save-settings').textContent = t.saveSettings;
    }

    document.getElementById('language').onchange = (e) => {
      settings.language = e.target.value;
      updateUI();
    };

    document.getElementById('save-settings').onclick = () => {
      settings.language = document.getElementById('language').value;
      settings.provider = document.getElementById('provider').value;
      settings.chatModelId = document.getElementById('chat-model-id').value;
      settings.codingModelId = document.getElementById('coding-model-id').value;
      settings.apiKey = document.getElementById('api-key').value;
      settings.thinking = document.getElementById('thinking-checkbox').checked;

      parent.postMessage({ pluginMessage: { type: 'save-settings', settings } }, '*');

      const t = translations[settings.language];
      document.getElementById('settings-status').textContent = t.settingsSaved;
      setTimeout(() => { document.getElementById('settings-status').textContent = ''; }, 2000);
    };

    // Load initial settings
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === 'load-settings' && msg.settings) {
        settings = msg.settings;
        if (!settings.language) settings.language = 'zh-CN'; // Default to Chinese

        // Backfill model IDs if missing from older settings
        if (!settings.chatModelId) settings.chatModelId = settings.modelId || 'doubao-seed-1-8-251228';
        if (!settings.codingModelId) settings.codingModelId = 'doubao-seed-code-preview-251028';

        document.getElementById('language').value = settings.language;
        document.getElementById('provider').value = settings.provider || 'volcengine';
        document.getElementById('chat-model-id').value = settings.chatModelId;
        document.getElementById('coding-model-id').value = settings.codingModelId;
        document.getElementById('api-key').value = settings.apiKey || '';
        const thinkingCheckbox = document.getElementById('thinking-checkbox');
        if (thinkingCheckbox) thinkingCheckbox.checked = settings.thinking !== false;

        updateUI();
      } else {
        // Initial UI update if no settings yet (default Chinese)
        updateUI();
      }
    };

    // Get Font Awesome icons from HTML
    const getIconsMap = async (html) => {
      const iconMap = {};
      // Matches class="... fa fa-icon ..." or class="... fa-icon ..."
      const faRegex = /class=["']([^"']*\bfa[-a-z0-9]*\b[^"']*)["']/g;
      const matches = [...html.matchAll(faRegex)];

      const fetchIcon = async (className) => {
        // Default to FA4 style if no modern style prefixes are found
        let version = "4.7.0";
        let style = "solid";

        if (className.includes('fa-solid') || className.includes('fas')) { style = 'solid'; version = '6.x'; }
        else if (className.includes('fa-regular') || className.includes('far')) { style = 'regular'; version = '6.x'; }
        else if (className.includes('fa-brands') || className.includes('fab')) { style = 'brands'; version = '6.x'; }
        else if (className.includes('fa-light') || className.includes('fal')) { style = 'light'; version = '6.x'; }
        else if (className.includes('fa-thin') || className.includes('fat')) { style = 'thin'; version = '6.x'; }

        const iconMatches = className.matchAll(/\bfa-([a-z0-9-]+)\b/g);
        for (const iconMatch of iconMatches) {
          const iconName = iconMatch[1];
          // Filter out utility classes
          if (['fa', 'solid', 'regular', 'brands', 'light', 'thin', 'duotone', 'xs', 'sm', 'lg', 'xl', '2xl', 'fw', '2xs', '3x', '4x', '5x', '6x', '7x', '8x', '9x', '10x', 'spin', 'pulse', 'stack', 'inverse'].includes(iconName)) continue;

          const key = version === '4.7.0' ? `fa4/${iconName}` : `${style}/${iconName}`;
          if (iconMap[key]) continue;

          try {
            let url;
            if (version === '4.7.0') {
              url = `https://raw.githubusercontent.com/encharm/font-awesome-svg-png/master/black/svg/${iconName}.svg`;
            } else {
              url = `https://raw.githubusercontent.com/FortAwesome/Font-Awesome/6.x/svgs/${style}/${iconName}.svg`;
            }

            const response = await fetch(url);
            if (response.ok) {
              iconMap[key] = await response.text();
            } else if (version === '6.x' && style !== 'solid') {
              // Fallback to solid for FA6
              const fallbackUrl = `https://raw.githubusercontent.com/FortAwesome/Font-Awesome/6.x/svgs/solid/${iconName}.svg`;
              const fallbackRes = await fetch(fallbackUrl);
              if (fallbackRes.ok) {
                iconMap[key] = await fallbackRes.text();
              }
            } else if (version === '4.7.0') {
              // Compatibility: If FA4 search fails, try FA6 solid
              const fallbackUrl = `https://raw.githubusercontent.com/FortAwesome/Font-Awesome/6.x/svgs/solid/${iconName}.svg`;
              const fallbackRes = await fetch(fallbackUrl);
              if (fallbackRes.ok) {
                iconMap[key] = await fallbackRes.text();
              }
            }
          } catch (e) { console.error(e); }
        }
      };

      await Promise.all(matches.map(match => fetchIcon(match[1])));
      return iconMap;
    };

    // Conversion logic
    document.getElementById('convert').onclick = async () => {
      const html = document.getElementById('html-input').value;
      const viewport = document.querySelector('input[name="viewport"]:checked').value;
      const status = document.getElementById('tailwind-status');
      const t = translations[settings.language];

      if (!html) return;
      status.textContent = t.processingIcons;
      const iconMap = await getIconsMap(html);

      parent.postMessage({ pluginMessage: { type: 'convert-html', html, viewport, icons: iconMap } }, '*');
      status.textContent = t.sentToFigma;
      setTimeout(() => { status.textContent = ''; }, 2000);
    };

    // AI Builder logic
    let abortController = null;
    let lastGeneratedCode = "";

    const copyBtn = document.getElementById('copy-btn');
    copyBtn.onclick = () => {
      if (!lastGeneratedCode) return;
      const textArea = document.createElement("textarea");
      textArea.value = lastGeneratedCode;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand("Copy");
      textArea.remove();

      // Visual feedback
      const originalHTML = copyBtn.innerHTML;
      copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
      setTimeout(() => {
        copyBtn.innerHTML = originalHTML;
      }, 2000);
    };

    document.getElementById('stop-btn').onclick = () => {
      if (abortController) {
        abortController.abort();
      }
    };

    document.getElementById('expand-btn').onclick = async () => {
      const promptInput = document.getElementById('prompt-input');
      const prompt = promptInput.value;
      const btn = document.getElementById('expand-btn');
      const buildBtn = document.getElementById('build-btn');
      const status = document.getElementById('builder-status');
      const thinkingContainer = document.getElementById('thinking-container');
      const thinkingLine = document.getElementById('thinking-line');
      const t = translations[settings.language];

      if (!prompt) {
        status.textContent = t.enterDescription;
        return;
      }
      if (!settings.apiKey) {
        status.textContent = t.setApiKey;
        return;
      }

      btn.disabled = true;
      buildBtn.disabled = true;
      btn.classList.add('loading');
      status.textContent = '';
      status.style.display = 'none';
      thinkingContainer.classList.add('active');
      document.getElementById('thinking-status').textContent = t.expandingPrompt;
      document.getElementById('token-counter').textContent = `0 ${t.tokens}`;

      abortController = new AbortController();

      try {
        const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
          method: 'POST',
          signal: abortController.signal,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${settings.apiKey}`
          },
          body: JSON.stringify({
            model: settings.chatModelId,
            stream: true,
            thinking: document.getElementById('thinking-checkbox').checked ? undefined : { type: 'disabled' },
            messages: [
              {
                role: 'system',
                content: `You are an expert product manager and UX designer. TASK: Expand the user's short description into a detailed requirement document for a web page design in Figma. Focus on: 1. UI components (e.g., sections, buttons, input fields, text blocks). 2. One or two sentences about the task the user is going to accomplish. IMPORTANT: Do NOT include detailed colors, typography specs, or style descriptions (e.g., "blue gradient", "rounded corners"). Return ONLY the expanded description text, no intro/outro. OUTPUT LANGUAGE: ${settings.language === 'zh-CN' ? 'Chinese (Simplified)' : 'English'}`
              },
              { role: 'user', content: prompt }
            ]
          })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error?.message || 'API request failed');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";
        let reasoningText = "";
        let totalEstimatedTokens = 0;

        // clear input for streaming
        promptInput.value = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.trim().startsWith('data: ')) {
              const dataText = line.trim().slice(6);
              if (dataText === '[DONE]') continue;

              try {
                const data = JSON.parse(dataText);
                const delta = data.choices[0].delta;

                if (delta.reasoning_content) {
                  reasoningText += delta.reasoning_content;
                  document.getElementById('thinking-status').textContent = t.aiThinking;
                } else if (delta.content) {
                  document.getElementById('thinking-status').textContent = t.generating;
                  promptInput.value = fullText;
                  promptInput.scrollTop = promptInput.scrollHeight;
                  lastGeneratedCode = fullText;
                }

                totalEstimatedTokens = Math.floor((reasoningText.length + fullText.length) / 4);
                document.getElementById('token-counter').textContent = `${totalEstimatedTokens} ${t.tokens}`;
              } catch (e) {
                console.warn('Failed to parse chunk:', dataText);
              }
            }
          }
        }
        status.textContent = t.expanded;

      } catch (err) {
        if (err.name === 'AbortError') {
          status.textContent = t.stoppedByUser;
        } else {
          status.textContent = `${t.errorPrefix}${err.message}`;
        }
      } finally {
        status.style.display = 'block';
        btn.disabled = false;
        buildBtn.disabled = false;
        btn.classList.remove('loading');
        thinkingContainer.classList.remove('active');
        if (lastGeneratedCode) copyBtn.style.display = 'flex';
        abortController = null;
      }
    };

    document.getElementById('build-btn').onclick = async () => {
      const prompt = document.getElementById('prompt-input').value;
      const viewport = document.querySelector('input[name="builder-viewport"]:checked').value;
      const btn = document.getElementById('build-btn');
      const expandBtn = document.getElementById('expand-btn');
      const status = document.getElementById('builder-status');
      const thinkingContainer = document.getElementById('thinking-container');
      const thinkingLine = document.getElementById('thinking-line');
      const t = translations[settings.language];

      if (!prompt) {
        status.textContent = t.enterDescription;
        return;
      }
      if (!settings.apiKey) {
        status.textContent = t.setApiKey;
        return;
      }

      btn.disabled = true;
      expandBtn.disabled = true;
      btn.classList.add('loading');
      status.textContent = '';
      status.style.display = 'none';
      copyBtn.style.display = 'none';
      thinkingContainer.classList.add('active');
      document.getElementById('thinking-status').textContent = t.contactingAI;
      document.getElementById('token-counter').textContent = `0 ${t.tokens}`;

      abortController = new AbortController();

      const viewportDesc = viewport === 'mobile'
        ? "Target Viewport: Mobile (375px width). Use single-column layouts, larger touch targets, and vertical stacking."
        : "Target Viewport: Desktop (1440px width). Use multi-column layouts, horizontal alignment, and whitespace effectively.";

      try {
        const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
          method: 'POST',
          signal: abortController.signal,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${settings.apiKey}`
          },
          body: JSON.stringify({
            model: settings.codingModelId,
            stream: true,
            thinking: document.getElementById('thinking-checkbox').checked ? undefined : { type: 'disabled' },
            messages: [
              {
                role: 'system',
                content: `You are an elite UI engineer. TASK: Generate a standalone HTML snippet using Tailwind CSS classes based on the user description. ${viewportDesc} RULES: 1. Only return code, no markdown block wrappers. 2. Use modern, premium aesthetics. 3. Ensure full responsiveness. 4. Use Font Awesome icons where appropriate (fa-solid fa-icon) and vibrant colors. 5. Include decent padding and gap for a clean look. 6. Content Language: ${settings.language === 'zh-CN' ? 'Chinese (Simplified)' : 'English'}. Ensure all text in the generated HTML is in ${settings.language === 'zh-CN' ? 'Chinese' : 'English'}. 7. IMPORTANT: Do NOT generate a tailwind.config.js file. Use arbitrary values for specific colors (e.g., bg-[#123456], text-[#abcdef]) directly in the class names. 8. Prefer Flexbox over Grid for all layouts. Use Grid only if absolutely necessary for complex two-dimensional structures.`
              },
              { role: 'user', content: prompt }
            ]
          })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error?.message || 'API request failed');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullHtml = "";
        let reasoningText = "";
        let totalEstimatedTokens = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.trim().startsWith('data: ')) {
              const dataText = line.trim().slice(6);
              if (dataText === '[DONE]') continue;

              try {
                const data = JSON.parse(dataText);
                const delta = data.choices[0].delta;

                if (delta.reasoning_content) {
                  reasoningText += delta.reasoning_content;
                  document.getElementById('thinking-status').textContent = t.aiThinking;
                } else if (delta.content) {
                  fullHtml += delta.content;
                  document.getElementById('thinking-status').textContent = t.generating;
                  lastGeneratedCode = fullHtml;
                }

                totalEstimatedTokens = Math.floor((reasoningText.length + fullHtml.length) / 4);
                document.getElementById('token-counter').textContent = `${totalEstimatedTokens} ${t.tokens}`;

              } catch (e) {
                console.warn('Failed to parse chunk:', dataText);
              }
            }
          }
        }

        let html = fullHtml.trim();
        html = html.replace(/^```html\n?/, '').replace(/\n?```$/, ''); // fallback cleanup

        document.getElementById('thinking-status').textContent = t.buildingLayers;
        const iconMap = await getIconsMap(html);

        status.textContent = t.buildingLayers;
        parent.postMessage({ pluginMessage: { type: 'convert-html', html, viewport, icons: iconMap } }, '*');
        status.textContent = t.buildComplete;

      } catch (err) {
        if (err.name === 'AbortError') {
          status.textContent = t.generationStopped;
        } else {
          status.textContent = `${t.errorPrefix}${err.message}`;
        }
      } finally {
        status.style.display = 'block';
        btn.disabled = false;
        expandBtn.disabled = false;
        btn.classList.remove('loading');
        thinkingContainer.classList.remove('active');
        if (lastGeneratedCode) copyBtn.style.display = 'flex';
        abortController = null;
      }
    };

    document.getElementById('cancel-tailwind').onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    };
  </script>
</body>

</html>